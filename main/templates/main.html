{% extends 'base.html' %}

{% block content %}
<!-- CSS------------------------------------------------------------------- -->
    <style>
        body {
            background-color: #f4f7ff;
            margin: 12px;
        }

        h1, h2, h3, h4, h5, p, th, td, a, button {
            font-family: 'Poppins', sans-serif;
        }
        
        .navbar{
        position: sticky;
        top: 0;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        margin-bottom: 20px;
        background-color: rgba(255, 255, 255, 0.5);
        }

        .navbar img {
            max-height: 28px;
            padding-right: 20px;
            
        }

        .navbar-brand {
            color: #76797b;
            font-weight: 500;
            font-size: 16x;
        }


        .navbar .navbar-nav .nav-item {
            margin-right: 10px; /* Mengatur jarak antar item */
            padding-top: 3px;
            padding-bottom: 3px;
        }

        .navbar .navbar-nav .nav-item-active{
            background: #4161ff20; ;
            border-radius: 99px; 
            padding-left: 20px;
            padding-right: 20px;
            margin-left: 20px;
            margin-right: 20px;
            padding-top: 3px;
            padding-bottom: 3px;
            color: #4162FF;
            font-weight: 600;
        }
        
        .content-container {
            display: flex;
            flex-direction: column; 
            align-items: center;
            min-height: 0;
            text-align: center;
            margin-bottom: 5px;
        }

        .text-center {
            text-align: center;
            margin-bottom: 2px
        }
        
        .banner {
        max-width: 100%;
        height: auto;
        margin-bottom: 50px; 
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            background-color: #4162FF; 
            border-radius: 20px 20px 20px 20px; 
            margin-bottom: 20px
        }

        table tr:last-child td {
            background-color: #d7e3ef; 
            color: #160323; 
            font-weight: 500; 
        }

        th {
            border: 1px solid #ffffff;
            padding: 16px; 
            text-align: left;
            color: #fff; 
            font-size: 18px; 
        }

        td {
            border: 1px solid #ffffff;
            padding: 12px;
            text-align: left;
            background-color: #EEF4FB; 
            color: #060a21; 
            line-height: 150%;
        }

        td.description {
            max-width: 400px; 
            overflow-y: auto;
        }

        .center-text {
            text-align: center;
        }

        .card-container {
            margin-top: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            flex-wrap: nowrap; 
            justify-content: flex-start; 
            gap: 5px;
            overflow-x: auto; 
            justify-items: center; 
            align-items: center;
            justify-content: center;
            margin: 28px;
        }
        
        .card {
            background-color: #ffffff;
            margin: 12px;
            border-radius: 24px;
            box-shadow: 0px 5px 10px rgba(0, 0, 0, 0);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin-bottom: 16px;
            width:100%;
            min-width: 420px;
        }

            @media (min-width: 768px) {
            .card-container {
                grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
                justify-content: center;
            }
        }

            @media (min-width: 1200px) {
            .card-container {
                grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); 
                justify-content: center;
            }
        } 

            @media (min-width: 2400px) {
                .card-container {
                    grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); 
                    justify-content: center;
                }
            } 

        .card img {
            max-width: 100%;
            border-radius: 24px;
            height: auto;
        }

        .card-content {
            padding: 10px; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card-content h4 {
            font-size: 18px;
            margin: 5px 0; 
        }

        .card-content p {
            font-size: 14px;
            margin: 5px 0; 
        }

        .card:hover {
            transform: scale(1.04);
            transition: transform 0.24s ease;
        }
        
        .card-grid {
            display: flex;
            flex-direction: row; 
            flex-wrap: nowrap; 
            justify-content: flex-start; 
            gap: 20px; 
            overflow-x: auto; 
            white-space: nowrap; 
        }

        .add-product-button {
            display: inline-flex;
            height: 48px;
            padding: 4px 16px;
            justify-content: center;
            align-items: center;
            gap: 8px;
            border-radius: 12px;
            background: var(--primary-blue, #4162FF);
            color: #fff;
            text-decoration: none;
            border: none;
            cursor: pointer; 
        }

        .add-card-button {
            font-size: 18px;
            font-weight: 600;
            margin-top: 10px;
            width: 300px;
            height: 56px;
            border-radius: 20px;
            background: var(--primary-blue, #4161ff1f);
            color:#4162FF;
        }

        .add-amount-button{
            background: var(--primary-blue, #4161ff1f);
            color:#4162FF;
            padding: 20px 0px;
            margin:4px;
            border-radius: 1000px;
            width: 100%;
        }

        .logout-button {
            background-color: #ff1d1d; 
            width:96px
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            width: 100%; 
            
        }

        .action-buttons a {
            width: 100%;
        }

        .svg-button {
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 12px;
            background-color: var(--primary-red, #ff1d1d);
            color: #fff;
            text-decoration: none;
            border: none;
            cursor: pointer;
            height: 48px;
            padding: 4px 16px;
            min-width: 56px;
        }

        .color-gray{
            color:#76797b;
        }
        
        .action-gap{
            padding: 12px;
        }

        @media (max-width: 768px) {
            .card {
                width: calc(50% - 20px); 
            }
        }

        @media (min-width: 769px) {
            .card {
                width: calc(33.33% - 20px); 
            }
        }

        .text-title{
            font-weight: 700;
            font-size: 28px;
        }

        .text-title-semi{
            font-weight: 600;
            font-size:28px;
        }

        .amount-img {
            max-height: 28px;
            max-width: 28px;
            
        }
    </style>
    
<!-- NAVBAR------------------------------------------------------------------- -->
<div class="navbar navbar-expand-lg bg-white">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand d-none d-lg-block" href="#">üõíüé®</a>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <ul class="navbar-nav">
                <li class="nav-item-active">
                    <a class="nav-link" style="color: #4162FF;" href="{% url 'main:login' %}">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Product</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="https://awekadesign.com/"  target="_blank" rel="noopener noreferrer">My Website</a>
                </li>
            </ul>
        </div>
        <a class="nav-link" type="button"  data-bs-target="#exampleModal" data-bs-toggle="modal" style="color: #4162FF; font-weight: 600; padding-right: 20px;" >Make Product by Ajax</a>

        <div class="ml-auto"> 
            <div class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="bi bi-person-circle"></i> {{ name }}, {{ class }}
                </a>
                <div class="dropdown-menu" aria-labelledby="profileDropdown">
                    <a class="dropdown-item" href="https://www.linkedin.com/in/aryawijaya/ " target="_blank" rel="noopener noreferrer" >Profile</a>
                    <a class="dropdown-item" href="{% url 'main:logout' %}">Logout</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Banner------------------------------------------------------------------- -->
<div class="content-container">
    <img class="banner" alt="Banner " src="https://user-images.githubusercontent.com/119391657/270735230-a8b5cf60-8116-418d-b8f9-abb976d4bc01.png" loading="lazy">
    <h1 class="text-title">üñºÔ∏è üë®üèª‚Äçüé® List of Art üé® üî•</h1>
</div>

<!-- Card ------------------------------------------------------------------- -->
    <div id="product_card" class="card-container"></div>

<!-- Total Karya------------------------------------------------------------------- -->
    <div class="text-center">
        <h2 class="total text-title-semi" style="padding-top: 28px; padding-bottom: 12px;">Anda telah membuat karya sebanyak: {{total}} karya üé®üñºÔ∏è</h2>
    </div>

<!-- Tabel ------------------------------------------------------------------- -->
    <table id="product_table"></table>

<!-- Sesi Login------------------------------------------------------------------- -->
    <h4>Sesi terakhir login: {{ last_login }} </h4>

<!-- Button Logout, Create Product ------------------------------------------------------------------- -->
    <a href="{% url 'main:logout' %}" class=" add-product-button logout-button">
        Logout
    </a>

    <a href="{% url 'main:create_product' %}" class="add-product-button ">
        Add New Product Biasa
    </a>

<!-- Modal------------------------------------------------------------------- -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Add New Product</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form" onsubmit="return false;">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="name" class="col-form-label">Name:</label>
                        <input type="text" class="form-control" id="name" name="name"></input>
                    </div>

                    <div class="mb-3">
                        <label for="name" class="col-form-label">Artist:</label>
                        <input type="text" class="form-control" id="artist" name="artist"></input>
                    </div>

                    <div class="mb-3">
                        <label for="price" class="col-form-label">Price:</label>
                        <input type="number" class="form-control" id="price" name="price"></input>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="col-form-label">Description:</label>
                        <textarea class="form-control" id="description" name="description"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="image_url" class="col-form-label">Image Url:</label>
                        <textarea class="form-control" id="image_url" name="image_url"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="detail" class="col-form-label">Detail:</label>
                        <textarea class="form-control" id="detail" name="detail"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="button_add" data-bs-dismiss="modal">Add Product</button>
            </div>
        </div>
    </div>
</div>

<!-- Java Script------------------------------------------------------------------- -->
    <script>
        // Get product pakai JSON ----------------------------------------------------
        async function getProducts() {
            return fetch("{% url 'main:get_product_json' %}").then((res) => res.json())
        }

        //TABLE -------------------------------------------------------------------------
        async function refreshProducts() {
            document.getElementById("product_table").innerHTML = ""
            const products = await getProducts()
            let htmlString = `<tr>
                <th>Name</th>
                <th>Price</th>
                <th>Description</th>
                <th>Date Added</th>
                <th> Amount </th>
                <th> Action </th>
            </tr>`

        products.forEach((item) => {
            htmlString += `<tr>
                <td>${item.fields.name}</td>
                <td>$${item.fields.price}</td>
                <td class="description" style ="max-width: 400px; overflow-y: auto;">${item.fields.description}</td>
                <td>${item.fields.date_added}</td>
                <td class="center-text action-row">
                    <div class="action-buttons">
                        <div class="action-buttons">
                            <button onclick="decreaseAmount(${item.pk})" class="add-product-button add-amount-button" style="padding: 20px 0px;">
                                <img class="amount-img" src="https://user-images.githubusercontent.com/119391657/271369281-5bed9a9f-af4f-4278-b7ef-d9bb22694678.png">
                            </button>

                            <span id="amount-${item.pk}">${item.fields.amount}</span>

                            <button onclick="increaseAmount(${item.pk})" class="add-product-button add-amount-button" style ="padding: 20px 0px;">
                                <img class="amount-img" src="https://user-images.githubusercontent.com/119391657/271369291-047353e6-0659-40b5-8032-225335c346b1.png">
                            </button>
                        </div>
                    </div>
                </td>
                <td class="action-row">
                    <div class="action-buttons ">
                        <div class="action-buttons">
                            <a href="/edit-product/${item.pk}" class="add-product-button">
                            Edit
                        </a>
                        <button onClick="delete_product_ajax(${item.pk})" class="add-button add-product-button svg-button">
                            <img src="https://svgur.com/i/xtJ.svg" alt="SVG Image">
                        </button>
                        </div>
                    </div>
                </td>
            </tr>`;
        });
        document.getElementById("product_table").innerHTML = htmlString
        }

        refreshProducts()

        //CARD -------------------------------------------------------------------------
        async function refreshCard() {
            const productCard = document.getElementById("product_card");
            productCard.innerHTML = ""; 
            const products = await getProducts();
            let htmlString = "";

            products.forEach((item) => {
                htmlString += `
                    <div class="card border-0" style="padding: 10px; padding-bottom: 30px;">
                        <img class="card-img" src="${item.fields.image_url}" alt="Product Image">
                        <h3 style="margin: 20px 0px; font-size: 24px; font-weight: 700;">${item.fields.name}</h3>
                        <p style="margin: 0px 0px; font-size: 16px; font-weight: 500; margin-bottom: 8px">By: ${item.fields.artist}</p>
                        <a class="add-product-button add-card-button" href="${item.fields.detail}" target="_blank" rel="noopener noreferrer"> See Detail  </a>
                    </div>`;
            });

            document.getElementById("product_card").innerHTML = htmlString;
        }

        refreshCard();

        //ADD PRODUCT -------------------------------------------------------------------------
        function addProduct() {
            fetch("{% url 'main:add_product_ajax' %}", {
                method: "POST",
                body: new FormData(document.querySelector('#form'))
            }).then(refreshProducts).then(refreshCard)

            document.getElementById("form").reset()
            return false
        }

        document.getElementById("button_add").onclick = addProduct

        //INCREASE -------------------------------------------------------------------------
        function increaseAmount(productId) {
            fetch(`/increase_amount/${productId}`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                },
            })
                .then(() => refreshProducts())
                .catch((error) => console.error("Error:", error));
        }
        
        //DECREASE -------------------------------------------------------------------------
        function decreaseAmount(productId) {
            fetch(`/decrease_amount/${productId}`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                },
            })
                .then(() => refreshProducts())
                .catch((error) => console.error("Error:", error));
        }
        
        //Delete -------------------------------------------------------------------------
        function delete_product_ajax(ID) {
            fetch(`/remove_product_ajax/${ID}`, {
                method: 'DELETE',
            }).then(refreshProducts).then(refreshCard)
            }
        document.getElementById("add-button").onclick = addProduct
        
        //GET COOKIE -------------------------------------------------------------------------
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                var cookies = document.cookie.split(";");
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

{% endblock content %}